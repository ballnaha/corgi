# р╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓ User ID Mapping

## ЁЯРЫ р╕Ыр╕▒р╕Нр╕лр╕▓р╕Чр╕╡р╣Ир╕Юр╕Ъ

р╕гр╕░р╕Ър╕Ър╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓р╣Гр╕Щр╕Бр╕▓р╕г mapping р╕гр╕░р╕лр╕зр╣Ир╕▓р╕З LINE User ID р╣Бр╕ер╕░ Internal Database ID:

1. **Session User ID**: р╣Гр╕Кр╣Й LINE User ID (`U240b6492c0bffe4c330ce3457459b35f`)
2. **Database Orders**: р╕Др╣Йр╕Щр╕лр╕▓р╕Фр╣Йр╕зр╕в User ID р╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕Хр╕гр╕Зр╕Бр╕▒р╕Щ
3. **р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М**: р╣Др╕бр╣Ир╕Юр╕Ъ orders р╕кр╕│р╕лр╕гр╕▒р╕Ъ user

## ЁЯФз р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Чр╕╡р╣Ир╕Чр╕│

### 1. р╣Бр╕Бр╣Йр╣Др╕В NextAuth Configuration (`src/lib/auth.ts`)
- р╣Ар╕Юр╕┤р╣Ир╕б `token.id` р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Бр╣Зр╕Ъ internal database ID
- р╕Ыр╕гр╕▒р╕Ъ `session.user.id` р╣Гр╕лр╣Йр╣Гр╕Кр╣Й internal ID р╣Бр╕Чр╕Щ LINE ID
- р╣Ар╕Юр╕┤р╣Ир╕б fallback р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕нр╕Зр╕гр╕▒р╕Ъ backward compatibility

### 2. р╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕З Orders API (`src/app/api/orders/route.ts`)
- р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ user ID mapping
- р╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Чр╕▒р╣Йр╕З internal ID р╣Бр╕ер╕░ LINE ID
- р╣Ар╕Юр╕┤р╣Ир╕б logging р╣Ар╕Юр╕╖р╣Ир╕н debug

### 3. р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ (`scripts/fix-user-id-mapping.js`)
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е users р╣Бр╕ер╕░ orders р╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
- р╣Бр╕кр╕Фр╕З ID mapping patterns

## ЁЯУЛ р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ

### 1. р╕гр╕▒р╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ
```bash
node scripts/fix-user-id-mapping.js
```

### 2. р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕ер╣Зр╕нр╕Бр╕нр╕┤р╕Щр╣Гр╕лр╕бр╣И
1. р╕ер╕Зр╕Кр╕╖р╣Ир╕нр╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ
2. р╕ер╕Зр╕Кр╕╖р╣Ир╕нр╣Ар╕Вр╣Йр╕▓р╣Гр╕Кр╣Йр╕Ьр╣Ир╕▓р╕Щ LINE р╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З
3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ console logs р╕кр╕│р╕лр╕гр╕▒р╕Ъ user ID р╣Гр╕лр╕бр╣И

### 3. р╕Чр╕Фр╕кр╕нр╕Ъ Payment Notification
1. р╣Ар╕Вр╣Йр╕▓р╕лр╕Щр╣Йр╕▓ payment-notification р╕Фр╣Йр╕зр╕в orderNumber р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ console р╕кр╕│р╕лр╕гр╕▒р╕Ъ debug information
3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕гр╕░р╕Ър╕Ър╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З

## ЁЯФН Debug Information р╕Чр╕╡р╣Ир╕Др╕зр╕гр╕Фр╕╣

### Console Logs р╕Чр╕╡р╣Ир╕кр╕│р╕Др╕▒р╕Н:
```
тЬЕ Found user by lineUserId, using internal ID: [INTERNAL_ID]
Using userId for orders search: [INTERNAL_ID]
Searching for order with orderNumber: [ORDER_NUMBER]
```

### р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Session:
```javascript
// р╣Гр╕Щ browser console
console.log(await fetch('/api/auth/session').then(r => r.json()));
```

## ЁЯЪи р╕лр╕▓р╕Бр╕вр╕▒р╕Зр╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓

### р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 1: User р╣Др╕бр╣Ир╕бр╕╡ Orders
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ orders р╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Кр╣Й user ID р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
- р╕гр╕▒р╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╣р╕Др╕зр╕▓р╕бр╕кр╕▒р╕бр╕Юр╕▒р╕Щр╕Шр╣М

### р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 2: Session ID р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕нр╕▒р╕Ыр╣Ар╕Фр╕Х
- р╕ер╕Зр╕Кр╕╖р╣Ир╕нр╕нр╕нр╕Бр╣Бр╕ер╕░р╣Ар╕Вр╣Йр╕▓р╣Гр╕лр╕бр╣И
- р╣Ар╕Др╕ер╕╡р╕вр╕гр╣М browser cache/cookies
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ NextAuth configuration

### р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 3: Orders р╣Др╕бр╣Ир╕Хр╕гр╕Зр╕Бр╕▒р╕Ъ User
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ userId р╣Гр╕Щ orders table
- р╕нр╕▓р╕Ир╕Хр╣Йр╕нр╕Зр╕нр╕▒р╕Ыр╣Ар╕Фр╕Х orders р╣Гр╕лр╣Йр╣Гр╕Кр╣Й internal user ID

## ЁЯУЮ р╕Хр╕┤р╕Фр╕Хр╣Ир╕н Support

р╕лр╕▓р╕Бр╕вр╕▒р╕Зр╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓ р╕Бр╕гр╕╕р╕Ур╕▓р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Фр╕▒р╕Зр╕Щр╕╡р╣Й:
1. Console logs р╕Ир╕▓р╕Бр╕Бр╕▓р╕гр╕гр╕▒р╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣М
2. Screenshot р╕Вр╕нр╕З error message
3. OrderNumber р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕Чр╕Фр╕кр╕нр╕Ъ
4. Browser console logs
