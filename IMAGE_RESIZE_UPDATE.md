# การปรับปรุงการ Upload รูปภาพในหน้า Admin Product New

## การเปลี่ยนแปลงที่ทำ

### 1. ปรับ API Upload Image (`src/app/api/upload/image/route.ts`)
- **เดิม**: สร้างรูป 4 ขนาด (original, large 800x600, medium 400x300, thumbnail 150x150)
- **ใหม่**: สร้างเฉพาะรูป large ขนาด 600x800 (อัตราส่วน 3:4)

```typescript
// เดิม
const sizes = [
  { name: 'original', width: null, height: null },
  { name: 'large', width: 800, height: 600 },
  { name: 'medium', width: 400, height: 300 },
  { name: 'thumbnail', width: 150, height: 150 },
];

// ใหม่
const sizes = [
  { name: 'large', width: 600, height: 800 }, // 3:4 aspect ratio
];
```

### 2. ปรับหน้า Admin Product New (`src/app/admin/products/new/page.tsx`)
- **เดิม**: ใช้รูป medium สำหรับบันทึกในฐานข้อมูล
- **ใหม่**: ใช้รูป large สำหรับบันทึกในฐานข้อมูล

```typescript
// เดิม
images: uploadedImages.filter(img => img.size === 'medium').map((img, index) => ({

// ใหม่
images: uploadedImages.filter(img => img.size === 'large').map((img, index) => ({
```

### 2. แก้ไข Path Image Product ในหน้าแรก (`src/app/page.tsx`)
- **ปัญหา**: ใช้ `imageUrl` โดยตรงแทนที่จะใช้รูปจาก `images` array
- **แก้ไข**: ปรับให้ใช้รูปหลัก (isMain: true) จาก `images` array ก่อน แล้วค่อย fallback ไปยัง `imageUrl`

### 3. แก้ไข Path Image Product ในหน้า Favorites (`src/app/favorites/page.tsx`)
- **ปัญหา**: เหมือนกับหน้าแรก
- **แก้ไข**: ปรับให้ใช้รูปหลักจาก `images` array

### 4. ปรับปรุงการลบสินค้าในหน้า Admin (`src/app/admin/products/page.tsx`)
- **เพิ่ม**: ลบไฟล์รูปออกจาก folder เมื่อลบสินค้า
- **เพิ่ม**: Confirm dialog แทน alert ธรรมดา
- **สร้าง**: ConfirmDialog component ใหม่ (`src/components/ConfirmDialog.tsx`)

### 5. ปรับปรุง API ลบสินค้า (`src/app/api/products/[id]/route.ts`)
- **เพิ่ม**: ลบไฟล์รูปจาก filesystem ก่อนลบข้อมูลในฐานข้อมูล
- **ปรับปรุง**: Error handling สำหรับกรณีไฟล์ไม่พบ

### 6. เพิ่มหน้าแก้ไขสินค้า (`src/app/admin/products/edit/[id]/page.tsx`)
- **สร้างหน้าใหม่**: หน้าแก้ไขสินค้าที่ใช้ form เดียวกับหน้าสร้างสินค้า
- **จัดการรูปภาพ**: 
  - แสดงรูปภาพปัจจุบัน
  - เพิ่มรูปภาพใหม่ได้
  - ลบรูปภาพเก่าได้
  - ลบไฟล์รูปจาก server เมื่อลบรูปภาพ
- **ปรับปรุง API PATCH**: รองรับการอัปเดตรูปภาพ (เพิ่ม/ลบ/แก้ไข)

### 7. ปรับปรุงหน้า Admin Products (`src/app/admin/products/page.tsx`)
- **แสดงสินค้าทั้งหมด**: รวมสินค้าที่ `isActive = false` ด้วย
- **สร้าง API ใหม่**: `/api/admin/products` สำหรับ admin (แสดงสินค้าทั้งหมด)
- **ปรับ Category Filter**: ดึง categories จาก API แทน hardcode
- **แสดงชื่อ Category**: แปลง category key เป็นชื่อที่อ่านง่าย

### 8. เพิ่มการแสดง Percent ส่วนลดในรูป
- **ProductCard**: เพิ่ม discount badge ที่มุมบนซ้ายของรูป
- **ProductDetail**: เพิ่ม discount badge ในหน้ารายละเอียดสินค้า
- **Admin Products**: ปรับปรุงการแสดง discount badge ให้แสดง percent ที่ถูกต้อง
- **คำนวณอัตโนมัติ**: คำนวณ percent จาก salePrice หรือใช้ discountPercent ที่กำหนด

### 9. เพิ่มหน้า Admin จัดการผู้ใช้งาน (`src/app/admin/users/page.tsx`)
- **หน้าจัดการผู้ใช้**: แสดงรายการผู้ใช้ทั้งหมดในระบบ
- **สถิติผู้ใช้**: แสดงจำนวนผู้ใช้ทั้งหมด, ผู้ใช้ที่ใช้งาน, admin, ผู้ใช้ใหม่
- **ค้นหาผู้ใช้**: ค้นหาด้วยชื่อ, อีเมล, LINE ID
- **รายละเอียดผู้ใช้**: แสดงข้อมูลผู้ใช้, จำนวนคำสั่งซื้อ, ยอดซื้อรวม
- **การจัดการ**: ดูรายละเอียด, ตั้งเป็น admin, เปิด/ปิดใช้งาน
- **ใช้ API เดิม**: `/api/admin/users` ที่มีอยู่แล้ว

## ผลลัพธ์
1. **ประหยัดพื้นที่เก็บข้อมูล**: ลดจาก 4 ไฟล์ต่อรูป เหลือ 1 ไฟล์ต่อรูป
2. **อัตราส่วนใหม่**: รูปภาพจะมีอัตราส่วน 3:4 (600x800 พิกเซล) เหมาะสำหรับการแสดงผลสินค้า
3. **คุณภาพคงเดิม**: ยังคงใช้ JPEG quality 85% เหมือนเดิม
4. **ความเข้ากันได้**: รูปภาพเก่าที่มีอยู่แล้วยังคงทำงานได้ปกติ
5. **แสดงรูปถูกต้อง**: หน้าแรกและหน้า favorites จะแสดงรูปจาก images array ที่อัปโหลดใหม่
6. **การลบสินค้าปรับปรุง**: 
   - ลบไฟล์รูปออกจาก server อัตโนมัติ
   - UI/UX ดีขึ้นด้วย confirm dialog แทน alert
   - แสดงสถานะ loading ขณะลบ
7. **เพิ่มการแก้ไขสินค้า**:
   - หน้าแก้ไขสินค้าที่สมบูรณ์
   - จัดการรูปภาพได้ครบถ้วน (เพิ่ม/ลบ/แก้ไข)
   - ลบไฟล์รูปจาก server เมื่อลบรูปภาพ
   - UI/UX เหมือนหน้าสร้างสินค้า
8. **ปรับปรุงหน้า Admin Products**:
   - แสดงสินค้าทั้งหมด (รวม isActive = false)
   - Category filter ดึงจาก API (ไม่ hardcode)
   - แสดงชื่อ category ที่อ่านง่าย
   - API แยกสำหรับ admin และ public
9. **การแสดง Percent ส่วนลด**:
   - Badge ส่วนลดในรูปภาพทุกหน้า (หน้าแรก, favorites, รายละเอียด, admin)
   - คำนวณ percent อัตโนมัติจาก salePrice หรือใช้ discountPercent
   - UI สวยงามด้วย badge สีแดงที่มุมบนซ้าย
   - แสดงเฉพาะเมื่อมีส่วนลดจริง
10. **หน้า Admin จัดการผู้ใช้งาน**:
   - แสดงสถิติผู้ใช้แบบ real-time
   - ตารางผู้ใช้พร้อม pagination และ search
   - ดูรายละเอียดผู้ใช้ในป๊อปอัป
   - จัดการสิทธิ์และสถานะผู้ใช้
   - เมนูใน admin sidebar และ dashboard

## การทดสอบ
1. **การอัปโหลดรูป**:
   - เข้าหน้า Admin → Products → New Product
   - อัปโหลดรูปภาพใหม่
   - ตรวจสอบว่ารูปที่บันทึกมีขนาด 600x800 พิกเซล (อัตราส่วน 3:4)
   - ตรวจสอบว่ามีเฉพาะไฟล์ large เท่านั้นในโฟลเดอร์ `/public/uploads/products/`

2. **การแสดงรูป**:
   - ตรวจสอบว่าสินค้าใหม่แสดงรูปถูกต้องในหน้าแรกและหน้า favorites
   - ตรวจสอบว่ารูปแสดงผลด้วยอัตราส่วน 3:4

3. **การลบสินค้า**:
   - เข้าหน้า Admin → Products
   - คลิกเมนู 3 จุดของสินค้าที่ต้องการลบ
   - คลิก "ลบ" และตรวจสอบว่า confirm dialog แสดงขึ้น
   - ยืนยันการลบและตรวจสอบว่าไฟล์รูปถูกลบออกจาก `/public/uploads/products/`

4. **การแก้ไขสินค้า**:
   - เข้าหน้า Admin → Products
   - คลิกเมนู 3 จุดของสินค้าที่ต้องการแก้ไข
   - คลิก "แก้ไข" เพื่อไปหน้าแก้ไขสินค้า
   - ตรวจสอบว่าข้อมูลและรูปภาพปัจจุบันแสดงถูกต้อง
   - ทดสอบการเพิ่ม/ลบรูปภาพ
   - บันทึกการแก้ไขและตรวจสอบว่าข้อมูลอัปเดตถูกต้อง

5. **การแสดงสินค้าใน Admin**:
   - ตรวจสอบว่าสินค้าที่ปิดขาย (isActive = false) แสดงในหน้า admin
   - ทดสอบ category filter ว่าแสดง categories ที่มีจริงจากฐานข้อมูล
   - ตรวจสอบว่าชื่อ category แสดงเป็นภาษาไทยที่อ่านง่าย
   - ทดสอบการกรองตาม status (เปิดขาย/ปิดขาย)

6. **การแสดง Percent ส่วนลด**:
   - ตรวจสอบว่าสินค้าที่มี salePrice แสดง discount badge ในรูป
   - ตรวจสอบว่าสินค้าที่มี discountPercent แสดง badge ถูกต้อง
   - ทดสอบการคำนวณ percent อัตโนมัติจาก salePrice
   - ตรวจสอบการแสดงผลในทุกหน้า (หน้าแรก, favorites, รายละเอียด, admin)

7. **หน้า Admin จัดการผู้ใช้งาน**:
   - เข้าหน้า Admin → Users หรือคลิก "จัดการผู้ใช้" ใน dashboard
   - ตรวจสอบสถิติผู้ใช้ (ทั้งหมด, ใช้งาน, admin, ใหม่เดือนนี้)
   - ทดสอบการค้นหาผู้ใช้ด้วยชื่อหรืออีเมล
   - คลิกเมนู 3 จุดเพื่อดูรายละเอียดผู้ใช้
   - ทดสอบการแสดงข้อมูลคำสั่งซื้อและยอดซื้อรวม

## หมายเหตุ
- การเปลี่ยนแปลงนี้จะมีผลกับรูปภาพที่อัปโหลดใหม่เท่านั้น
- รูปภาพเก่าที่มีอยู่แล้วจะยังคงใช้งานได้ปกติ
- หากต้องการปรับรูปภาพเก่าให้เป็นขนาดใหม่ จะต้องอัปโหลดใหม่